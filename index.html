<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda LABP2D</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h1>Agenda LABP2D</h1>
  <div id="calendar"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyp5tlqTuCAQeOYPwXeK38JFOxVKlQ0ZTqxLG5pFnKYmtKazzhp71Fq46TwzLHkgkrp/exec';
    const userEmail = prompt("Informe seu e-mail institucional:");

    async function fetchEvents() {
      const response = await fetch(API_URL);
      const data = await response.json();
      return data.map(event => ({
        id: event.id,
        title: event.title,
        start: event.start,
        end: event.end,
        extendedProps: { creator: event.creator }
      }));
    }

    async function sendRequest(method, payload) {
      const response = await fetch(API_URL, {
        method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      return response.json();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const calendarEl = document.getElementById('calendar');
      const events = await fetchEvents();

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        editable: true,
        events,
        select: async function(info) {
          const title = prompt('Título do evento:');
          if (title) {
            const newEvent = {
              userEmail,
              title,
              start: info.startStr,
              end: info.endStr
            };
            const result = await sendRequest('POST', newEvent);
            if (result.status === 'ok') {
              calendar.addEvent({
                id: result.eventId,
                title,
                start: info.startStr,
                end: info.endStr,
                extendedProps: { creator: userEmail }
              });
            } else {
              alert(result.message);
            }
          }
        },
        eventChange: async function(changeInfo) {
          const event = changeInfo.event;
          if (event.extendedProps.creator !== userEmail) {
            alert('Você não tem permissão para editar este evento.');
            changeInfo.revert();
            return;
          }
          const payload = {
            userEmail,
            eventId: event.id,
            title: event.title,
            start: event.start,
            end: event.end
          };
          const result = await sendRequest('PUT', payload);
          if (result.status !== 'ok') {
            alert(result.message);
            changeInfo.revert();
          }
        },
        eventClick: async function(info) {
          if (info.event.extendedProps.creator !== userEmail) {
            alert('Você não tem permissão para excluir este evento.');
            return;
          }
          if (confirm(`Deseja excluir o evento "${info.event.title}"?`)) {
            const payload = {
              userEmail,
              eventId: info.event.id
            };
            const result = await sendRequest('DELETE', payload);
            if (result.status === 'ok') {
              info.event.remove();
            } else {
              alert(result.message);
            }
          }
        }
      });

      calendar.render();
    });
  </script>
</body>
</html>
